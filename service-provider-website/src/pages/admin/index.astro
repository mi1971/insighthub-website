---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getFile } from "../../lib/github";

export const prerender = false;

if (!Astro.cookies.has("auth_token")) {
    return Astro.redirect("/admin/login");
}

let posts = [];
let error = null;

try {
    const fileList = await getFile("service-provider-website/src/content/blog");
    if (Array.isArray(fileList)) {
        posts = fileList.filter(
            (f: any) => f.name.endsWith(".md") || f.name.endsWith(".mdx"),
        );
    }
} catch (e) {
    console.error("Failed to fetch posts from GitHub:", e);
    error = "Failed to load posts from GitHub. Check your configuration.";
}
---

<BaseLayout title="Admin Dashboard">
    <div class="max-w-7xl mx-auto pt-32 pb-6 sm:px-6 lg:px-8">
        <div class="px-4 py-6 sm:px-0">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-900">Blog Posts</h1>
                <a
                    href="/admin/edit/new"
                    class="bg-[#6B4E3D] hover:opacity-90 text-white font-bold py-2 px-4 rounded"
                >
                    Create New Post
                </a>
            </div>

            {
                error && (
                    <div
                        class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4"
                        role="alert"
                    >
                        <strong class="font-bold">Error: </strong>
                        <span class="block sm:inline">{error}</span>
                    </div>
                )
            }

            <div class="bg-white shadow overflow-hidden sm:rounded-md">
                <ul class="divide-y divide-gray-200">
                    {
                        posts.map((post: any) => (
                            <li>
                                <a
                                    href={`/admin/edit/${post.name}`}
                                    class="block hover:bg-gray-50"
                                >
                                    <div class="px-4 py-4 sm:px-6">
                                        <div class="flex items-center justify-between">
                                            <p class="text-sm font-medium text-[--color-accent] truncate">
                                                {post.name}
                                            </p>
                                            <div class="ml-2 flex-shrink-0 flex">
                                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                                                    Published
                                                </span>
                                            </div>
                                        </div>
                                        <div class="mt-2 sm:flex sm:justify-between">
                                            <div class="sm:flex">
                                                <p class="flex items-center text-sm text-gray-500">
                                                    {post.path}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </a>
                            </li>
                        ))
                    }
                    {
                        posts.length === 0 && !error && (
                            <li class="px-4 py-4 sm:px-6 text-center text-gray-500">
                                No posts found or GitHub authentication missing.
                            </li>
                        )
                    }
                </ul>
            </div>
        </div>
    </div>
</BaseLayout>
